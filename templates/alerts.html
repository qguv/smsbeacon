{% extends 'base.html' %}

{% block head %}
    {{ super() }}

    <!-- fetch polyfill -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
{% endblock head %}

{% block content %}

<form id="alert_form" action="{{ url_for('new_alert', locid=locid) }}" method="post">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
<textarea name="text" autofocus></textarea>
<input type="submit" value="Queue it" />
</form>

<h3>Pending</h3>
<ul>
{% for msg, aid in alerts.get(AlertType.REPORT_PENDING, []) %}
    <li>
        {{ msg }}
        <ul>
            <li>
                <button onclick="putAlert('{{ url_for('put_alert', locid=locid, alert=aid) }}', {{ AlertType.REPORT_RELAYED }})">
                    Approve
                </button>
            </li>
            <li>
                <button onclick="putAlert('{{ url_for('put_alert', locid=locid, alert=aid) }}', {{ AlertType.REPORT_REJECTED }})">
                    Reject
                </button>
            </li>
        </ul>
    </li>
{% endfor %}
</ul>

<h3>Sent recently</h3>
<ul>
{% for msg, _ in alerts.get(AlertType.REPORT_RELAYED, []) + alerts.get(AlertType.WALLOPS_RELAYED, []) %}
    <li>{{ msg }}</li>
{% endfor %}
</ul>

<h3>Rejected recently</h3>
<ul>
{% for msg, _ in alerts.get(AlertType.REPORT_REJECTED, []) %}
    <li>{{ msg }}</li>
{% endfor %}
</ul>


<script>
function putAlert(url, status) {
    let fd = new FormData();
    fd.append('status', status);
    fd.append('csrf_token', '{{ csrf_token() }}');

    fetch(url, {
        method: 'PUT',
        body: fd,
        credentials: 'include',
        headers: new Headers()
    }).then(_ => location.reload());
}
</script>
{% endblock %}
